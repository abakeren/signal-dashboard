<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Signal Bot Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const { TimeScale, LinearScale, Tooltip, Legend } = Chart;
    Chart.register(
      TimeScale, LinearScale, Tooltip, Legend,
      window['chartjs-chart-financial'].CandlestickController,
      window['chartjs-chart-financial'].CandlestickElement
    );
  </script>
  <style>
    :root { --bg:#0f172a; --card:#1e293b; --line:#334155; --muted:#94a3b8; --text:#f8fafc; --buy:#22c55e; --sell:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;padding:20px;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    h1,h2{margin:0 0 10px;text-align:center}
    .wrap{max-width:1200px;margin:0 auto}
    .card{background:var(--card);border-radius:10px;padding:16px;border:1px solid var(--line)}
    .grid{display:grid;gap:16px}
    .buy{color:var(--buy);font-weight:700}
    .sell{color:var(--sell);font-weight:700}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border:1px solid var(--line);padding:8px;text-align:center}
    th{background:var(--card)}
    tr:nth-child(even){background:var(--card)}
    .muted{color:var(--muted)}
    .debug{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;background:#0b1222;border:1px solid #27354d;border-radius:8px;padding:10px;color:#cbd5e1}
  </style>
</head>
<body>
  <div class="wrap grid">
    <h1>üìä Mini Signal Bot Dashboard</h1>

    <!-- Active Signal -->
    <div class="card">
      <h2>Active Signal</h2>
      <canvas id="candleChart" height="220"></canvas>
      <div id="signalDetail" class="muted" style="margin-top:12px;"></div>
      <div id="candleDebug" class="debug" style="margin-top:10px;display:none"></div>
    </div>

    <!-- Table -->
    <div class="card">
      <h2>Top 10 Signals</h2>
      <table id="signalTable">
        <thead>
          <tr>
            <th>Time</th><th>Pair</th><th>Side</th><th>Entry</th>
            <th>SL</th><th>TP1</th><th>TP2</th><th>TP3</th>
            <th>Score</th><th>RSI</th><th>Vol</th><th>Note</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="signalsHint" class="muted" style="margin-top:8px;"></div>
      <div id="signalsDebug" class="debug" style="margin-top:10px;display:none"></div>
    </div>
  </div>

  <script>
    // === CSV LINKS (punya kamu) ===
    const SHEET_CANDLES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSlYbUbL8Tn3CC0wcDXWs1uxsVKfpyvKFEzjZRyMyPmbXZKbqNjt2gcR3GHJ_8C4Ix6Cmm6OCMVQaQM/pub?gid=1706276702&single=true&output=csv";
    const SHEET_SIGNALS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSlYbUbL8Tn3CC0wcDXWs1uxsVKfpyvKFEzjZRyMyPmbXZKbqNjt2gcR3GHJ_8C4Ix6Cmm6OCMVQaQM/pub?gid=1760384152&single=true&output=csv";

    // ---- Helpers ----
    function showDebug(id, title, content){
      const el = document.getElementById(id);
      el.style.display = 'block';
      el.textContent = `${title}\n${content}`;
    }

    function headerIndex(headers, nameCandidates){
      // cari kolom berdasar nama (case-insensitive), dukung variasi
      const idx = headers.findIndex(h => {
        const x = (h||"").toString().trim().toLowerCase();
        return nameCandidates.some(n => x === n);
      });
      return idx >= 0 ? idx : null;
    }

    async function parseCSV(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      return new Promise((resolve, reject) => {
        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          complete: (r)=> resolve(r.data),
          error: reject
        });
      });
    }

    // ---- Render CANDLES ----
    async function loadCandles(){
      try{
        const rows = await parseCSV(SHEET_CANDLES);
        if(!rows || rows.length === 0) throw new Error("Candles CSV kosong");

        // normalisasi nama kolom
        const headers = Object.keys(rows[0]).map(h => h.trim());
        const colTime = headerIndex(headers.map(h=>h.toLowerCase()), ["time","timestamp","date"]);
        const colOpen = headerIndex(headers.map(h=>h.toLowerCase()), ["open","o"]);
        const colHigh = headerIndex(headers.map(h=>h.toLowerCase()), ["high","h"]);
        const colLow  = headerIndex(headers.map(h=>h.toLowerCase()), ["low","l"]);
        const colClose= headerIndex(headers.map(h=>h.toLowerCase()), ["close","c","price"]);

        if([colTime,colOpen,colHigh,colLow,colClose].some(x=>x===null)){
          showDebug("candleDebug","Candles - Header tidak cocok:",
            `Headers:\n${headers.join(", ")}\n\nButuh minimal: time, open, high, low, close`);
          return;
        }

        const key = (i)=> headers[i];
        const candles = rows.map(r => ({
          x: new Date(r[key(colTime)]),
          o: +r[key(colOpen)],
          h: +r[key(colHigh)],
          l: +r[key(colLow)],
          c: +r[key(colClose)]
        })).filter(v => isFinite(v.o)&&isFinite(v.h)&&isFinite(v.l)&&isFinite(v.c));

        const ctx = document.getElementById("candleChart").getContext("2d");
        if(window.candleChart) window.candleChart.destroy();
        window.candleChart = new Chart(ctx, {
          type: 'candlestick',
          data: { datasets: [{ label: "Candles", data: candles }] },
          options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip:{mode:'index', intersect:false} },
            scales: {
              x: { type: 'time', ticks:{ color:"#94a3b8"}, grid:{ color:"#334155"} },
              y: { ticks:{ color:"#94a3b8"}, grid:{ color:"#334155"} }
            }
          }
        });
      }catch(err){
        showDebug("candleDebug","Candles - Error:", String(err));
      }
    }

    // ---- Render SIGNALS ----
    async function loadSignals(){
      try{
        const rows = await parseCSV(SHEET_SIGNALS);
        if(!rows || rows.length === 0) throw new Error("Signals CSV kosong");

        const headers = Object.keys(rows[0]).map(h => h.trim());
        const lower = headers.map(h=>h.toLowerCase());

        const ci = {
          time:  headerIndex(lower, ["time","timestamp","date"]),
          pair:  headerIndex(lower, ["pair","symbol"]),
          side:  headerIndex(lower, ["side","dir","direction"]),
          price: headerIndex(lower, ["price","entry","close"]),
          sl:    headerIndex(lower, ["sl","stop","stoploss","stop_loss"]),
          tp1:   headerIndex(lower, ["tp1","takeprofit1","take_profit_1"]),
          tp2:   headerIndex(lower, ["tp2","takeprofit2","take_profit_2"]),
          tp3:   headerIndex(lower, ["tp3","takeprofit3","take_profit_3"]),
          score: headerIndex(lower, ["score"]),
          rsi:   headerIndex(lower, ["rsi"]),
          vol:   headerIndex(lower, ["vol_ratio","vol","volume_ratio"]),
          note:  headerIndex(lower, ["note","notes","remarks"])
        };

        const need = ["time","pair","side","price","sl","tp1","tp2","tp3","score","rsi","vol","note"];
        if (need.some(k => ci[k]===null)){
          showDebug("signalsDebug","Signals - Header tidak cocok:",
            `Headers:\n${headers.join(", ")}\n\nButuh kolom (nama boleh bervariasi):\n${need.join(", ")}`);
          return;
        }

        // isi detail aktif (row terakhir)
        const key = (i)=> headers[i];
        const last = rows[rows.length-1];
        document.getElementById("signalDetail").innerHTML = `
          <b>Pair:</b> ${last[key(ci.pair)]}<br/>
          <b>Side:</b> <span class="${String(last[key(ci.side)]).toUpperCase()==="BUY"?"buy":"sell"}">${last[key(ci.side)]}</span><br/>
          <b>Entry:</b> ${last[key(ci.price)]} &nbsp; | &nbsp; <b>SL:</b> ${last[key(ci.sl)]}<br/>
          <b>TP1:</b> ${last[key(ci.tp1)]} &nbsp; <b>TP2:</b> ${last[key(ci.tp2)]} &nbsp; <b>TP3:</b> ${last[key(ci.tp3)]}<br/>
          <b>Score:</b> ${last[key(ci.score)]} &nbsp; | &nbsp; <b>RSI:</b> ${last[key(ci.rsi)]} &nbsp; | &nbsp; <b>Vol:</b> ${last[key(ci.vol)]}<br/>
          <b>Note:</b> ${last[key(ci.note)]}
        `;

        // isi tabel (10 terbaru)
        const tbody = document.querySelector("#signalTable tbody");
        tbody.innerHTML = "";
        const latest = rows.slice(-10).reverse();
        for (const r of latest){
          const tr = document.createElement("tr");
          const sideVal = String(r[key(ci.side)]).toUpperCase();
          tr.innerHTML = `
            <td>${r[key(ci.time)]}</td>
            <td>${r[key(ci.pair)]}</td>
            <td class="${sideVal==="BUY"?"buy":"sell"}">${r[key(ci.side)]}</td>
            <td>${r[key(ci.price)]}</td>
            <td>${r[key(ci.sl)]}</td>
            <td>${r[key(ci.tp1)]}</td>
            <td>${r[key(ci.tp2)]}</td>
            <td>${r[key(ci.tp3)]}</td>
            <td>${r[key(ci.score)]}</td>
            <td>${r[key(ci.rsi)]}</td>
            <td>${r[key(ci.vol)]}</td>
            <td>${r[key(ci.note)]}</td>
          `;
          tbody.appendChild(tr);
        }

        document.getElementById("signalsHint").textContent = "";
      }catch(err){
        document.getElementById("signalsHint").textContent =
          "‚ö†Ô∏è Gagal memuat 'Signals'. Pastikan link CSV benar & public.";
        showDebug("signalsDebug","Signals - Error:", String(err));
      }
    }

    async function refresh(){
      await Promise.all([loadCandles(), loadSignals()]);
    }

    refresh();
    setInterval(refresh, 60000);
  </script>
</body>
</html>
