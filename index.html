<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Signal Bot Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js UMD (paling kompatibel) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Adapter time (date-fns) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <!-- Financial plugin UMD -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0/dist/index.umd.min.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Register core scales & plugins
    const { Chart, TimeScale, LinearScale, Tooltip, Legend } = window;
    Chart.register(TimeScale, LinearScale, Tooltip, Legend);

    // Coba register financial plugin (UMD menaruh export pada window['chartjs-chart-financial'])
    (function registerFinancial(){
      const F =
        window['chartjs-chart-financial'] ||
        window.chartjsChartFinancial ||
        window.ChartjsChartFinancial;

      if (F && F.CandlestickController) {
        Chart.register(
          F.CandlestickController, F.CandlestickElement,
          F.OhlcController,        F.OhlcElement
        );
        console.log('[financial] candlestick registered');
      } else {
        console.warn('[financial] plugin not found – will line-chart fallback if needed');
      }
    })();

    window.candleChart = null; // sentinel
  </script>

  <style>
    :root { --bg:#0f172a; --card:#1e293b; --line:#334155; --muted:#94a3b8; --text:#f8fafc; --buy:#22c55e; --sell:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;padding:20px;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    h1,h2{margin:0 0 10px;text-align:center}
    .wrap{max-width:1200px;margin:0 auto}
    .card{background:var(--card);border-radius:10px;padding:16px;border:1px solid var(--line)}
    .grid{display:grid;gap:16px}
    .buy{color:var(--buy);font-weight:700}
    .sell{color:var(--sell);font-weight:700}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border:1px solid var(--line);padding:8px;text-align:center}
    th{background:var(--card)}
    tr:nth-child(even){background:var(--card)}
    .muted{color:var(--muted)}
    .debug{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;background:#0b1222;border:1px solid #27354d;border-radius:8px;padding:10px;color:#cbd5e1;display:none}
  </style>
</head>
<body>
  <div class="wrap grid">
    <h1>📊 Mini Signal Bot Dashboard</h1>

    <div class="card">
      <h2>Active Signal</h2>
      <canvas id="candleChart" height="220"></canvas>
      <div id="signalDetail" class="muted" style="margin-top:12px;"></div>
      <div id="candleDebug" class="debug"></div>
    </div>

    <div class="card">
      <h2>Top 10 Signals</h2>
      <table id="signalTable">
        <thead>
          <tr>
            <th>Time</th><th>Pair</th><th>Side</th><th>Entry</th>
            <th>SL</th><th>TP1</th><th>TP2</th><th>TP3</th>
            <th>Score</th><th>RSI</th><th>Vol</th><th>Note</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="signalsHint" class="muted" style="margin-top:8px;"></div>
      <div id="signalsDebug" class="debug"></div>
    </div>
  </div>

  <script>
    // ======= LINKS (pakai publish-to-web + fallback gviz) =======
    const SHEET_ID = "1W_AOr_oATVQpmbbHh1agM42Wu8i5pJgqL3CUroyYLoM";
    const URLS = {
      candles: [
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vSlYbUbL8Tn3CC0wcDXWs1uxsVKfpyvKFEzjZRyMyPmbXZKbqNjt2gcR3GHJ_8C4Ix6Cmm6OCMVQaQM/pub?gid=1706276702&single=true&output=csv",
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=1706276702`,
      ],
      signals: [
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vSlYbUbL8Tn3CC0wcDXWs1uxsVKfpyvKFEzjZRyMyPmbXZKbqNjt2gcR3GHJ_8C4Ix6Cmm6OCMVQaQM/pub?gid=1760384152&single=true&output=csv",
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=1760384152`,
      ]
    };

    // ======= Fetch helpers (dengan proxy fallback supaya anti CORS) =======
    async function fetchTextWithFallback(urls) {
      const proxies = [
        null,
        (u)=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
        (u)=>`https://thingproxy.freeboard.io/fetch/${u}`,
      ];
      let lastErr;
      for (const url of urls) {
        for (const p of proxies) {
          const finalUrl = p ? p(url) : url;
          try {
            const res = await fetch(finalUrl, { cache:"no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.text();
          } catch (e) { lastErr = e; }
        }
      }
      throw lastErr || new Error("fetch failed");
    }

    async function parseCSVFrom(urlList, debugId){
      const txt = await fetchTextWithFallback(urlList);
      const dbg = document.getElementById(debugId);
      if (dbg) { dbg.style.display='block'; dbg.textContent = `CSV preview:\n${txt.split("\n").slice(0,3).join("\n")}`; }
      return new Promise((resolve, reject) => {
        Papa.parse(txt, { header:true, skipEmptyLines:true, complete:r=>resolve(r.data), error:reject });
      });
    }

    function colIdx(headers, names){
      const lower = headers.map(h=> (h||"").toString().trim().toLowerCase());
      const i = lower.findIndex(h => names.includes(h));
      return i>=0 ? i : null;
    }

    // ======= Render Candles (dengan fallback line chart kalau plugin gagal) =======
    function drawCandlesOrLine(ctx, rows, headers, idxs){
      // siapkan data
      const get = i => headers[i];
      const points = rows.map(r=>({
        t: new Date(r[get(idxs.time)]),
        o: +r[get(idxs.open)], h:+r[get(idxs.high)], l:+r[get(idxs.low)], c:+r[get(idxs.close)]
      })).filter(v=>isFinite(v.o)&&isFinite(v.h)&&isFinite(v.l)&&isFinite(v.c));

      // jika candlestick belum terdaftar, fallback line close
      const hasCandle = !!Chart.registry.controllers.get('candlestick');

      if (window.candleChart && typeof window.candleChart.destroy === "function") window.candleChart.destroy();

      if (hasCandle){
        window.candleChart = new Chart(ctx, {
          type:'candlestick',
          data:{ datasets:[{ label:"Candles", data: points.map(p=>({x:p.t,o:p.o,h:p.h,l:p.l,c:p.c})) }] },
          options:{
            responsive:true,
            plugins:{ legend:{display:false} },
            scales:{
              x:{ type:'time', ticks:{color:"#94a3b8"}, grid:{color:"#334155"} },
              y:{ ticks:{color:"#94a3b8"}, grid:{color:"#334155"} }
            }
          }
        });
      } else {
        // fallback: line chart of close price
        window.candleChart = new Chart(ctx, {
          type:'line',
          data:{ datasets:[{ label:"Close", data: points.map(p=>({x:p.t,y:p.c})) }] },
          options:{
            responsive:true,
            elements:{ point:{ radius:0 } },
            plugins:{ legend:{ display:false } },
            scales:{
              x:{ type:'time', ticks:{color:"#94a3b8"}, grid:{color:"#334155"} },
              y:{ ticks:{color:"#94a3b8"}, grid:{color:"#334155"} }
            }
          }
        });
        document.getElementById("candleDebug").style.display='block';
        document.getElementById("candleDebug").textContent =
          'Financial plugin belum ter-register — ditampilkan fallback line chart.';
      }
    }

    async function loadCandles(){
      try{
        const rows = await parseCSVFrom(URLS.candles, "candleDebug");
        if(!rows.length) throw new Error("Candles CSV kosong");
        const headers = Object.keys(rows[0]).map(h=>h.trim());

        const idxs = {
          time:  colIdx(headers, ["time","timestamp","date"]),
          open:  colIdx(headers, ["open","o"]),
          high:  colIdx(headers, ["high","h"]),
          low:   colIdx(headers, ["low","l"]),
          close: colIdx(headers, ["close","c","price"])
        };
        if (Object.values(idxs).some(v=>v===null)){
          document.getElementById("candleDebug").style.display='block';
          document.getElementById("candleDebug").textContent =
            "Candles header tidak cocok.\nHeaders: " + headers.join(", ");
          return;
        }

        const ctx = document.getElementById("candleChart").getContext("2d");
        drawCandlesOrLine(ctx, rows, headers, idxs);
      }catch(e){
        const dbg = document.getElementById("candleDebug");
        dbg.style.display='block';
        dbg.textContent = "Candles Error:\n" + String(e);
      }
    }

    // ======= Signals =======
    async function loadSignals(){
      try{
        const rows = await parseCSVFrom(URLS.signals, "signalsDebug");
        if(!rows.length) throw new Error("Signals CSV kosong");
        const headers = Object.keys(rows[0]).map(h=>h.trim());
        const get = i => headers[i];

        const idx = {
          time:  colIdx(headers,["time","timestamp","date"]),
          pair:  colIdx(headers,["pair","symbol"]),
          side:  colIdx(headers,["side","dir","direction"]),
          price: colIdx(headers,["price","entry"]),
          sl:    colIdx(headers,["sl","stop","stoploss","stop_loss"]),
          tp1:   colIdx(headers,["tp1","takeprofit1","take_profit_1"]),
          tp2:   colIdx(headers,["tp2","takeprofit2","take_profit_2"]),
          tp3:   colIdx(headers,["tp3","takeprofit3","take_profit_3"]),
          score: colIdx(headers,["score"]),
          rsi:   colIdx(headers,["rsi"]),
          vol:   colIdx(headers,["vol_ratio","vol","volume_ratio"]),
          note:  colIdx(headers,["note","notes","remarks"])
        };

        const last = rows[rows.length-1];
        document.getElementById("signalDetail").innerHTML = `
          <b>Pair:</b> ${last[get(idx.pair)]}<br/>
          <b>Side:</b> <span class="${String(last[get(idx.side)]).toUpperCase()==="BUY"?"buy":"sell"}">${last[get(idx.side)]}</span><br/>
          <b>Entry:</b> ${last[get(idx.price)]} &nbsp; | &nbsp; <b>SL:</b> ${last[get(idx.sl)]}<br/>
          <b>TP1:</b> ${last[get(idx.tp1)]} &nbsp; <b>TP2:</b> ${last[get(idx.tp2)]} &nbsp; <b>TP3:</b> ${last[get(idx.tp3)]}<br/>
          <b>Score:</b> ${last[get(idx.score)]} &nbsp; | &nbsp; <b>RSI:</b> ${last[get(idx.rsi)]} &nbsp; | &nbsp; <b>Vol:</b> ${last[get(idx.vol)]}<br/>
          <b>Note:</b> ${last[get(idx.note)]}
        `;

        const tbody = document.querySelector("#signalTable tbody");
        tbody.innerHTML = "";
        rows.slice(-10).reverse().forEach(r=>{
          const sideVal = String(r[get(idx.side)]).toUpperCase();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r[get(idx.time)]}</td>
            <td>${r[get(idx.pair)]}</td>
            <td class="${sideVal==="BUY"?"buy":"sell"}">${r[get(idx.side)]}</td>
            <td>${r[get(idx.price)]}</td>
            <td>${r[get(idx.sl)]}</td>
            <td>${r[get(idx.tp1)]}</td>
            <td>${r[get(idx.tp2)]}</td>
            <td>${r[get(idx.tp3)]}</td>
            <td>${r[get(idx.score)]}</td>
            <td>${r[get(idx.rsi)]}</td>
            <td>${r[get(idx.vol)]}</td>
            <td>${r[get(idx.note)]}</td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById("signalsHint").textContent = "";
      }catch(e){
        document.getElementById("signalsHint").textContent = "⚠️ Gagal memuat 'Signals'.";
        const dbg = document.getElementById("signalsDebug");
        dbg.style.display='block';
        dbg.textContent = "Signals Error:\n" + String(e);
      }
    }

    async function refresh(){ await Promise.all([loadCandles(), loadSignals()]); }
    refresh();
    setInterval(refresh, 60_000);
  </script>
</body>
</html>
