<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Signal Bot Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js + financial plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0"></script>
  <script>
    Chart.register(
      window['chartjs-chart-financial'].CandlestickController,
      window['chartjs-chart-financial'].CandlestickElement
    );
  </script>
  <style>
    :root { --bg:#0f172a; --card:#1e293b; --line:#334155; --muted:#94a3b8; --text:#f8fafc; --buy:#22c55e; --sell:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;padding:20px;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    h1,h2{margin:0 0 10px;text-align:center}
    .wrap{max-width:1200px;margin:0 auto}
    .card{background:var(--card);border-radius:10px;padding:16px;border:1px solid var(--line)}
    .grid{display:grid;gap:16px}
    .buy{color:var(--buy);font-weight:700}
    .sell{color:var(--sell);font-weight:700}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border:1px solid var(--line);padding:8px;text-align:center}
    th{background:var(--card)}
    tr:nth-child(even){background:var(--card)}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap grid">
    <h1>üìä Mini Signal Bot Dashboard</h1>

    <!-- Active Signal -->
    <div class="card">
      <h2>Active Signal</h2>
      <canvas id="candleChart" height="220"></canvas>
      <div id="signalDetail" class="muted" style="margin-top:12px;"></div>
    </div>

    <!-- Table -->
    <div class="card">
      <h2>Top 10 Signals</h2>
      <table id="signalTable">
        <thead>
          <tr>
            <th>Time</th><th>Pair</th><th>Side</th><th>Entry</th>
            <th>SL</th><th>TP1</th><th>TP2</th><th>TP3</th>
            <th>Score</th><th>RSI</th><th>Vol</th><th>Note</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="signalsHint" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <script>
    // === CSV LINKS ===
    // Candles (SUDAH DIISI dari kamu):
    const SHEET_CANDLES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSlYbUbL8Tn3CC0wcDXWs1uxsVKfpyvKFEzjZRyMyPmbXZKbqNjt2gcR3GHJ_8C4Ix6Cmm6OCMVQaQM/pub?gid=1760384152&single=true&output=csv";
    // Signals (GANTI dengan link CSV tab 'Signals' kamu):
    const SHEET_SIGNALS = "https://docs.google.com/spreadsheets/d/1W_AOr_oATVQpmbbHh1agM42Wu8i5pJgqL3CUroyYLoM/edit?gid=1760384152#gid=1760384152"; // contoh: "https://docs.google.com/...&gid=XXXX&output=csv"

    async function loadCSV(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Fetch ${url} -> ${res.status}`);
      const text = await res.text();
      // dukung baris yang mengandung koma di dalam kutip
      const rows = [];
      let cur = "", inQ = false, row = [];
      for (let i=0;i<text.length;i++){
        const ch = text[i], nxt = text[i+1];
        if (ch === '"'){ inQ = !inQ; cur += ch; continue; }
        if (!inQ && ch === ","){ row.push(cur.replace(/^"|"$/g,"")); cur=""; continue; }
        if (!inQ && (ch === "\n" || (ch === "\r" && nxt === "\n"))){
          row.push(cur.replace(/^"|"$/g,"")); rows.push(row); row=[]; cur="";
          if (ch==="\r") i++; // lewati \n setelah \r
          continue;
        }
        cur += ch;
      }
      if (cur.length || row.length){ row.push(cur.replace(/^"|"$/g,"")); rows.push(row); }
      return rows.filter(r => r.some(x => x!== ""));
    }

    function renderTable(rows){
      const tbody = document.querySelector("#signalTable tbody");
      tbody.innerHTML = "";
      if (!rows || rows.length < 2) return;
      const latest = rows.slice(1).reverse().slice(0,10);
      for (const r of latest){
        // indeks kolom mengikuti format: time, pair, side, price, atr, sl, tp1, tp2, tp3, score, rsi, macd_hist, vol_ratio, note, alerted
        if (r.length < 14) continue;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r[0]}</td>
          <td>${r[1]}</td>
          <td class="${r[2]==="BUY"?"buy":"sell"}">${r[2]}</td>
          <td>${r[3]}</td>
          <td>${r[5]}</td>
          <td>${r[6]}</td>
          <td>${r[7]}</td>
          <td>${r[8]}</td>
          <td>${r[9]}</td>
          <td>${r[10]}</td>
          <td>${r[12]}</td>
          <td>${r[13]}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderActiveFromSignals(rows){
      if (!rows || rows.length < 2) return;
      const last = rows[rows.length-1];
      if (!last || last.length < 14) return;
      document.getElementById("signalDetail").innerHTML = `
        <b>Pair:</b> ${last[1]}<br/>
        <b>Side:</b> <span class="${last[2]==="BUY"?"buy":"sell"}">${last[2]}</span><br/>
        <b>Entry:</b> ${last[3]} &nbsp; | &nbsp; <b>SL:</b> ${last[5]}<br/>
        <b>TP1:</b> ${last[6]} &nbsp; <b>TP2:</b> ${last[7]} &nbsp; <b>TP3:</b> ${last[8]}<br/>
        <b>Score:</b> ${last[9]} &nbsp; | &nbsp; <b>RSI:</b> ${last[10]} &nbsp; | &nbsp; <b>Vol:</b> ${last[12]}<br/>
        <b>Note:</b> ${last[13]}
      `;
    }

    function renderCandle(candleRows){
      if (!candleRows || candleRows.length < 2) return;
      const candles = candleRows.slice(1).map(r => ({
        x: new Date(r[0]),
        o: +r[1], h: +r[2], l: +r[3], c: +r[4]
      }));
      const ctx = document.getElementById("candleChart").getContext("2d");
      if (window.candleChart) window.candleChart.destroy();
      window.candleChart = new Chart(ctx, {
        type: 'candlestick',
        data: { datasets: [{ label: "Candles", data: candles }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks:{ color:"#94a3b8"}, grid:{ color:"#334155"} },
            y: { ticks:{ color:"#94a3b8"}, grid:{ color:"#334155"} }
          }
        }
      });
    }

    async function refresh(){
      const [candleRows, signalRows] = await Promise.all([
        loadCSV(SHEET_CANDLES),
        SHEET_SIGNALS ? loadCSV(SHEET_SIGNALS).catch(()=>null) : Promise.resolve(null)
      ]);
      renderCandle(candleRows);
      if (signalRows){
        renderTable(signalRows);
        renderActiveFromSignals(signalRows);
        document.getElementById("signalsHint").textContent = "";
      } else {
        document.getElementById("signalsHint").textContent =
          "‚ö†Ô∏è Link CSV untuk tab 'Signals' belum diisi. Publish tab 'Signals' ‚Üí CSV, lalu set SHEET_SIGNALS di atas.";
      }
    }

    refresh();
    setInterval(refresh, 60000);
  </script>
</body>
</html>
